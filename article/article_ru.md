# Alfresco Inform Extension

## Вступление
Моей первой задаей при работе с Alfresco стала разарботка расширения, 
информирующего пользователей об измении версии интересующего их документа. Предполагается, что создатель, редакторы, ассоциированные пользователи и те, кто добавил файл в "Избранное" должны получать сообщеняи о новых версиях по почте, с указанием причины, по которой их об этом уведомили. При этом, нежелательно уведомлять пользователя несколько раз - соответственно нужно расставить приоритеты уведомления. Кроме того, было бы неплохо иметь возможность включать - выключать уведомления группами. С учетом всего этого я принялся за работу.

Процесс разработки осложнялся отсутствием внятной документации и более-менее полных примеров, и это привело к созданию данной статьи в том виде, в котором вы её читаете.

Алгоритм работы был избран такой:
* создаем класс
* подписываем его на событие "создание новой версии документа"
* проверяем какие группы нужно уведомить
* последовательно посылаем письма группам в порядке интереса (в данном случае: Создатель, Последний Редактор, Ассоциированный, Редактор, В избранных), запоминая тех, кому письмо уже отправлено. Каждая группа получает свои письма.

Поскольку я не очень люблю JS, то было решено использовать Java API. Быстро выяснилось, что Alfresco позволяет создавать собственные политики на многие события. На измения версий нашлось 4 политики (спасибо статье [Jared Ottley][1]):
* beforeCreateVersion
* onCreateVersion
* afterCreateVersion
* calculateVersionLabel

По вполне очвидным причинам лучше всего мне подошла "afterCreateVersion". Для вариантивности писем в Alfresco есть система шаблонов на основе FreeMakerTemplates. Отправка писем так же возможна через Alfresco. Ок, поехали!

## Пишем
***Внимание:*** Все примеры будут даваться с учетом того, что я писал в IntelliJ IDEA Community Edition потому что так сложилось. Так же все примеры опираются на текущую (v0.7) версию расширения, в дальнейшем код может (и будет) правиться.

Для начала нам понадобится JDK (в моем случае openjdk 1.8) и maven. С помощью Alfresco SDK (хороший [tutorial][2]) создаем новый Repo Project, выбираем версию 2.1.1, обзываем его как удобнее и получаем
<img> </img>
После чистки от всякого-разного и создания нового класса получается
<img> </img>

Заводим класс и наследуем его от политики:
<code> </code>

Получаем global.properties:
<code> </code>

и необходимые сервисы:
<code> </code>

Не забываем прописать bean, чтобы все корректно собралось:
<xml> </xml> 

Регистрируем поведение:
<code> </code>

Имплементим необходимый метод:
<code> </code>

В методе мы собираем информацию, которая потом будет использоваться во всех шаблонах, а так же создаем сет для информаированных пользователей. Свойства переименованы для безопасности и просто потому что могу:
<code> </code>

Тут же получаем из ноды её создателя:
<code> </code>

и последнего редактора из версии:
<code> </code>

Далее в заранее предусмотренном порядке начинаем информировать пользователей.
Сначала Создателя - после проверки флага сразу получаем шаблон письма по адресу:
<code> </code>

отправляем письмо:
<code> </code>

и добавляем Создателя в список Извещенных.

Затем Последнего редактора - все то же самое, но ещё нужно убедиться, что это не одно лицо с создателем:
<code> </code>

Для Ассоциированного пользователя нам нужно сделать чуть больше:
<code> </code>

Получаем список Ассоциированных из ноды:
<code> </code>

Удаляем уже извещенных:
<code> </code>

Если после этого ещё есть кого извещать - то берем шаблон и в цикле рассылаем письма. После этого всю пачку вгружаем в извещенные.

Для Редакторов принцип точно тот же самый:
<code> </code>

Излекаем Редакторов из всех версий:
<code> </code>

Удаляем извещенных:
<code> </code>

Рассылаем письма в цикле, добавляем в оповещенных.

Теперь нюансы. Для того чтобы шаблоны лежали по известному нам адресу, их нужно их туда положить. На помощь приходит bootstrap-context:
<xml> </xml>

Важно! Если вы будете загружать расширение в ту же Alfresco второй раз - Spring весело упадет из-за попытки вгрузить файлы на занятое место! Поэтому надо будет поставить флаг:
<xml> </xml>

Проверяем наличие bootstrap-context в conten-model
<xml> </xml>

Ну и сам шаблон. Для примера - тот, который уходит Ассоциированному:
<ftl> </ftl>

После создания пустого проекта у вас должен остаться log4j файл с demo-классом. Убираем его оттуда и подставляем свой. 
<conf> </conf>

И вписываем свою конфигурацию флагов в alfresco-global.properties
<conf> </conf>

Внимание! Расширение не заработает без настроенного Outbound Email, поэтому для тестов  можно вписать этот конфиг локально туда же:
<conf> </conf>

Осталось только правильно настроить pom.xml (я не говорю, что у меня он настроен правильно)
<xml> </xml>

И вуаля - extension готов!

Компилим:
<img/>

Запускаем с ним Alfresco:
<img/>
<img/>

Пробуем:
<img/>
<img/>
It works!

В планах:
* Добваить поддержку локализации средствами Alfresco
* Добавить хотя бы один тест

You should have flag mail.from.enabled set to true!!!!!11111ONEONE

[1]:http://jared.ottleys.net/alfresco/alfresco-max-version-policy/
[2]:http://ecmarchitect.com/alfresco-developer-series-tutorials/maven-sdk/tutorial/tutorial.html
